<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <title>Productbeheer</title>
</head>
<body>
  <div class="container">
    <h2>Productbeheer</h2>

    <!-- Product toevoegen -->
    <div class="form-group">
      <input type="text" id="name" placeholder="Naam" />
      <input type="number" id="price" placeholder="Prijs (‚Ç¨)" step="0.01" />
      <input type="text" id="text_color" placeholder="Tekstkleur (#000000)" />
      <input type="text" id="image_url" placeholder="Afbeelding URL (optioneel)" />
      <input type="file" id="image_upload" accept="image/*" />
      <input type="number" id="order_index" placeholder="Volgorde" />
      <button id="addProduct">‚ûï Toevoegen</button>
    </div>

    <!-- Productenlijst -->
    <table id="productTable">
      <thead>
        <tr>
          <th>Naam</th>
          <th>Prijs</th>
          <th>Afbeelding</th>
          <th>Kleur</th>
          <th>Volgorde</th>
          <th>Acties</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://vqtkolrpglbtjbozbwxl.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxdGtvbHJwZ2xidGpib3pid3hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NTQ0OTcsImV4cCI6MjA2ODQzMDQ5N30.Kck5a2iI1JFzeDhlDBHlndalzhyEPOwNklJ9Q7yG2FM'
    );

    const tableBody = document.querySelector('#productTable tbody');
    const bucket = 'product-images'; // ‚Üê jouw bucketnaam

    async function uploadImage(file) {
      const filename = `${Date.now()}_${file.name}`;
      const { data, error } = await supabase.storage.from(bucket).upload(filename, file, {
        cacheControl: '3600',
        upsert: false
      });
      if (error) {
        alert('Upload mislukt: ' + error.message);
        return null;
      }

      const { data: publicURL } = supabase.storage.from(bucket).getPublicUrl(filename);
      return publicURL.publicUrl;
    }

    async function fetchProducts() {
      const { data, error } = await supabase.from('products').select('*').order('order_index', { ascending: true });
      if (error) return alert('Kan producten niet laden');
      tableBody.innerHTML = '';
      data.forEach(p => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="color: ${p.text_color || 'black'}">${p.name}</td>
          <td>‚Ç¨${p.price.toFixed(2)}</td>
          <td><img src="${p.image_url}" style="max-height:50px;" /></td>
          <td>${p.text_color || 'zwart'}</td>
          <td>${p.order_index ?? ''}</td>
          <td>
            <button onclick="editProduct(${p.id})">‚úèÔ∏è</button>
            <button onclick="deleteProduct(${p.id})">üóëÔ∏è</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    document.getElementById('addProduct').onclick = async () => {
      const name = document.getElementById('name').value;
      const price = parseFloat(document.getElementById('price').value);
      const text_color = document.getElementById('text_color').value || 'black';
      const image_url_input = document.getElementById('image_url').value;
      const image_file = document.getElementById('image_upload').files[0];
      const order_index = parseInt(document.getElementById('order_index').value) || null;

      if (!name || isNaN(price)) return alert('Vul een geldige naam en prijs in.');

      let finalImageURL = image_url_input;
      if (!finalImageURL && image_file) {
        finalImageURL = await uploadImage(image_file);
        if (!finalImageURL) return;
      }

      await supabase.from('products').insert([{ name, price, text_color, image_url: finalImageURL, order_index }]);
      document.querySelectorAll('input').forEach(input => input.value = '');
      fetchProducts();
    };

    window.editProduct = async (id) => {
      const field = prompt("Welk veld wil je bewerken? (name, price, text_color, image_url, order_index)");
      if (!['name', 'price', 'text_color', 'image_url', 'order_index'].includes(field)) return alert("Ongeldig veld.");

      let newValue = prompt(`Nieuwe waarde voor ${field}:`);
      if (field === 'price') newValue = parseFloat(newValue);
      if (field === 'order_index') newValue = parseInt(newValue);

      if (!newValue && newValue !== 0) return;

      await supabase.from('products').update({ [field]: newValue }).eq('id', id);
      fetchProducts();
    };

    window.deleteProduct = async (id) => {
      if (!confirm("Weet je zeker dat je dit product wilt verwijderen?")) return;
      await supabase.from('products').delete().eq('id', id);
      fetchProducts();
    };

    fetchProducts();
  </script>
</body>
</html>
